<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Late Shuttle Live Map</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <style>
    #map {
      height: 400px;
      margin-top: 24px;
    }

    .container {
      max-width: 700px;
      margin: 40px auto;
    }
  </style>
</head>

<body>
  <nav class="navbar">
    <div class="navbar-container">
      <span class="navbar-brand">VUS Booking System</span>
      <div class="navbar-links">
        <a href="index.html">Home</a>
        <a href="schedule.html">VUS Schedule</a>
        <a href="map.html">Live Map</a>
      </div>
    </div>
  </nav>
  <div class="container">
    <h2>Late Shuttle - Live Location</h2>
    <div id="map"></div>
    <div id="status"></div>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Center on a default location (update as needed)
    var map = L.map('map').setView([0, 0], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);
    var marker = L.marker([0, 0]).addTo(map).bindPopup("Late Shuttle Bus");

    // Replace with your actual BUP coordinates
    const BUP_COORDS = [23.813380, 90.424620];

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function (pos) {
        const userLatLng = [pos.coords.latitude, pos.coords.longitude];

        // Add marker for user
        L.marker(userLatLng).addTo(map).bindPopup("You are here").openPopup();

        // Draw route from user to BUP
        L.Routing.control({
          waypoints: [
            L.latLng(userLatLng[0], userLatLng[1]),
            L.latLng(BUP_COORDS[0], BUP_COORDS[1])
          ],
          routeWhileDragging: false,
          draggableWaypoints: false,
          addWaypoints: false
        }).addTo(map);

      }, function () {
        alert("Could not get your location.");
      });
    } else {
      alert("Geolocation is not supported by your browser.");
    }

    function updateLocation() {
      fetch('/api/gps/bus6')
        .then(res => {
          if (!res.ok) throw new Error("No location yet");
          return res.json();
        })
        .then(loc => {
          marker.setLatLng([loc.lat, loc.lng]);
          map.setView([loc.lat, loc.lng]);
          marker.getPopup().setContent("Late Shuttle Bus<br>Last updated: " + new Date(loc.time).toLocaleTimeString());
          document.getElementById('status').innerText = "";
        })
        .catch(() => {
          document.getElementById('status').innerText = "No location data yet for Late Shuttle.";
        });
    }

    setInterval(updateLocation, 3000);
    updateLocation();
  </script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
</body>
</html>